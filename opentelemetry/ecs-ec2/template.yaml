AWSTemplateFormatVersion: 2010-09-09
Description: |
  Create an OTEL ECS Daemon Service on an ECS Cluster.
  NOTE: Contains conditional IAM roles (only created for s3 and Parameter Store). 
  IAM warning appears even when no IAM resources are created - this is expected and safe to acknowledge.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Basic Configuration"
        Parameters:
          - ClusterName
          - CoralogixRegion
          - CoralogixApiKey
          - CDOTImageVersion
      
      - Label:
          default: "S3 Configuration"
        Parameters:
          - S3ConfigBucket
          - S3ConfigKey
      
      - Label:
          default: "Container Configuration"
        Parameters:
          - Image
          - Memory
      
      - Label:
          default: "Health Check Configuration"
        Parameters:
          - HealthCheckEnabled
          - HealthCheckInterval
          - HealthCheckTimeout
          - HealthCheckRetries
          - HealthCheckStartPeriod
    
    ParameterLabels:
      S3ConfigBucket:
        default: "S3 Bucket Name"
      S3ConfigKey:
        default: "S3 Object Key (file path)"

      ClusterName:
        default: "ECS Cluster Name"
      CoralogixRegion:
        default: "Coralogix Region"
      CoralogixApiKey:
        default: "Coralogix API Key"
      CDOTImageVersion:
        default: "CDOT Image Version"
      Image:
        default: "Custom Image (overrides CDOTImageVersion)"
      Memory:
        default: "Memory (MiB)"
      HealthCheckEnabled:
        default: "Enable Health Check"
      HealthCheckInterval:
        default: "Health Check Interval (seconds)"
      HealthCheckTimeout:
        default: "Health Check Timeout (seconds)"
      HealthCheckRetries:
        default: "Health Check Retries"
      HealthCheckStartPeriod:
        default: "Health Check Start Period (seconds)"

Parameters:
  S3ConfigBucket:
    Type: String
    Description: |
      S3 bucket name containing the configuration file.
      Example: 'my-bucket'
    AllowedPattern: ".+"
    ConstraintDescription: "S3 bucket name is required."

  S3ConfigKey:
    Type: String
    Description: |
      S3 object key (file path) for the configuration file.
      Example: 'configs/otel-config.yaml'
    AllowedPattern: ".+"
    ConstraintDescription: "S3 object key is required."

  ClusterName:
    Description: |
      Name of the ECS Cluster onto which to deploy the OTEL Daemon Service.
    Type: String
    AllowedPattern: ".+"
    ConstraintDescription: "ECS cluster name is required."

  CDOTImageVersion:
    Description: |
      The Coralogix Distribution OpenTelemetry Image Version/Tag.
      View available tags here: https://hub.docker.com/r/coralogixrepo/coralogix-otel-collector/tags
      This is required when Custom Image is set to "none".
    Type: String
  
  Image:
    Description: |
      The OpenTelemetry Collector Image to use.
      If specified, this value will override the CDOTImageVersion parameter and
      the coralogix otel collector image.
    Default: "none"
    Type: String

  Memory:
    Description: |
      The amount of memory (in MiB) used by the task.
      Note that you cluster must have sufficient memory available to support the given value.
    Type: Number
    Default: "2048"

  CoralogixRegion:
      Type: String
      Description: "The Coralogix location region [EU1|EU2|AP1|AP2|AP3|US1|US2]]"
      AllowedValues:
        - EU1
        - EU2
        - AP1
        - AP2
        - AP3
        - US1
        - US2

  CoralogixApiKey:
    Type: String
    Description: "The Send-Your-Data API key for your Coralogix account. See: https://coralogix.com/docs/user-guides/account-management/api-keys/send-your-data-api-key/"
    NoEcho: true
    AllowedPattern: ".+"
    ConstraintDescription: "API Key required."

  HealthCheckEnabled:
    Type: String
    Description: Enable ECS container health check for the OTEL agent container.
    AllowedValues: ["true", "false"]
    Default: "false"

  HealthCheckInterval:
    Type: Number
    Description: Health check interval (seconds). Only used if HealthCheckEnabled is true
    Default: "30"

  HealthCheckTimeout:
    Type: Number
    Description: Health check timeout (seconds). Only used if HealthCheckEnabled is true
    Default: "5"

  HealthCheckRetries:
    Type: Number
    Description: Health check retries. Only used if HealthCheckEnabled is true
    Default: "3"

  HealthCheckStartPeriod:
    Type: Number
    Description: Health check start period (seconds). Only used if HealthCheckEnabled is true
    Default: "10"

Conditions:
  UseImage: !Not [!Equals [!Ref Image, "none"]]
  EnableHealthCheck: !Equals [!Ref HealthCheckEnabled, "true"]



Mappings:
  CoralogixRegionMap:
    EU1:
      Endpoint: ingress.coralogix.com:443
      Domain: coralogix.com
    EU2:
      Endpoint: ingress.eu2.coralogix.com:443
      Domain: eu2.coralogix.com
    AP1:
      Endpoint: ingress.coralogix.in:443
      Domain: coralogix.in
    AP2:
      Endpoint: ingress.coralogixsg.com:443
      Domain: coralogixsg.com
    AP3:
      Endpoint: ingress.ap3.coralogix.com:443
      Domain: ap3.coralogix.com
    US1:
      Endpoint: ingress.coralogix.us:443
      Domain: coralogix.us
    US2:
      Endpoint: ingress.cx498.coralogix.com:443
      Domain: cx498.coralogix.com

Resources:
  OtelTaskDefinition: 
    Type: AWS::ECS::TaskDefinition
    Properties:
      ExecutionRoleArn: !Ref OtelTaskExecutionRole
      TaskRoleArn: !Ref OtelTaskExecutionRole
      Family: opentelemetry
      RequiresCompatibilities:
        - EC2
      NetworkMode: host
      Volumes:
        - Name: hostfs
          Host:
            SourcePath: "/var/lib/docker/"
  
        - Name: docker-socket
          Host:
            SourcePath: /var/run/docker.sock

      ContainerDefinitions:
        - Name: coralogix-otel-agent
          Cpu: 0
          Memory: !Ref Memory
          Command: ["--config", !Sub "s3://${S3ConfigBucket}.s3.${AWS::Region}.amazonaws.com/${S3ConfigKey}"]
          Image: !If
            - UseImage
            - !Ref Image
            - !Sub "coralogixrepo/coralogix-otel-collector:${CDOTImageVersion}"

          Essential: true
          HealthCheck: !If
            - EnableHealthCheck
            - Command:
                - "/healthcheck"
              Interval: !Ref HealthCheckInterval
              Timeout: !Ref HealthCheckTimeout
              Retries: !Ref HealthCheckRetries
              StartPeriod: !Ref HealthCheckStartPeriod
            - !Ref AWS::NoValue

          PortMappings:
            # otel grpc endpoint
            - HostPort: 4317
              Protocol: tcp
              AppProtocol: grpc
              ContainerPort: 4317
            
            # otel http endpoint
            - HostPort: 4318
              Protocol: tcp
              ContainerPort: 4318

            # otel metrics endpoint
            - HostPort: 8888
              Protocol: tcp
              ContainerPort: 8888

            # pprof extension default port
            - HostPort: 1777
              Protocol: tcp
              ContainerPort: 1777

          # Privileged required to access certain host metrics
          Privileged: true

          MountPoints:
            - SourceVolume: hostfs
              ContainerPath: "/hostfs/var/lib/docker"
              ReadOnly: True

            - SourceVolume: docker-socket
              ContainerPath: /var/run/docker.sock

          Environment:
            - Name: CORALOGIX_DOMAIN
              Value: !FindInMap [CoralogixRegionMap, !Ref CoralogixRegion, Domain]
           
            - Name: CORALOGIX_PRIVATE_KEY
              Value: !Ref CoralogixApiKey

  # IAM Role for S3 access
  OtelTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-otel-task-execution-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyName: S3ReadAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource: !Sub "arn:aws:s3:::${S3ConfigBucket}/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !Sub "arn:aws:s3:::${S3ConfigBucket}"

  ECSService:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster: !Ref ClusterName
      LaunchType: EC2
      ServiceName: coralogix-otel-agent
      SchedulingStrategy: DAEMON
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true
      DeploymentController:
        Type: ECS
      ServiceConnectConfiguration:
        Enabled: false
      PlacementStrategies: []
      PlacementConstraints: []
      Tags:
        - Key: 'ecs:service:stackId'
          Value: !Ref 'AWS::StackId'
      EnableECSManagedTags: true
      TaskDefinition: !Ref OtelTaskDefinition 