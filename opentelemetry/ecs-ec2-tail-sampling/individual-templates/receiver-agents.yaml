AWSTemplateFormatVersion: '2010-09-09'
Description: 'Step 3: Deploy Receiver service'

Parameters:
  ClusterName:
    Type: String
    Default: otel-cluster
    Description: Name of the ECS cluster
  NamespaceId:
    Type: String
    Description: Cloud Map namespace ID (from Step 1)
  SubnetIds:
    Type: String
    Description: Comma-separated list of private subnets for ECS services
  SecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id
    Description: Security group for ECS tasks
  CDOTImageVersion:
    Type: String
    Description: |
      Docker image tag for the OpenTelemetry Collector (e.g., 0.129.1).
      Recommended: Use the official Coralogix supported version from https://github.com/coralogix/opentelemetry-helm-charts/blob/main/charts/opentelemetry-collector/Chart.yaml#L15
      All available tags: https://hub.docker.com/r/otel/opentelemetry-collector-contrib/tags
  Memory:
    Type: Number
    Default: 1024
    Description: Memory for ECS tasks (MiB)
  CoralogixRegion:
    Type: String
    Description: "The Coralogix location region [EU1|EU2|AP1|AP2|AP3|US1|US2]]"
    AllowedValues:
      - EU1
      - EU2
      - AP1
      - AP2
      - AP3
      - US1
      - US2
  CoralogixApiKey:
    Type: String
    Description: "The Send-Your-Data API key for your Coralogix account. See: https://coralogix.com/docs/user-guides/account-management/api-keys/send-your-data-api-key/"
    NoEcho: true
    AllowedPattern: ".+"
    ConstraintDescription: "API Key required."
  ApplicationName:
    Type: String
    Default: ecs-ec2-integration
    Description: Application name for Coralogix
  SubsystemName:
    Type: String
    Default: sampling
    Description: Subsystem name for Coralogix
  S3ConfigBucket:
    Type: String
    Description: |
      S3 bucket name containing the configuration file.
      Example: 'my-bucket'
  ReceiverS3ConfigKey:
    Type: String
    Description: |
      S3 object key for the Receiver configuration file.
      Example: 'configs/receiver-config.yaml'
    AllowedPattern: ".+"
    ConstraintDescription: "S3 object key is required."
  ReceiverTaskCount:
    Type: Number
    Default: 2
    Description: Number of Receiver tasks to run
  TaskExecutionRoleArn:
    Type: String
    Default: ""
    Description: |
      External IAM role ARN for receiver task execution.
      If provided, this role will be used instead of creating new roles.
      Leave empty to create new roles.
    AllowedPattern: "^$|^arn:aws:iam::[0-9]{12}:role/.*$"

Conditions:
  UseExternalRole: !Equals [!Ref TaskExecutionRoleArn, ""]

Mappings:
  CoralogixRegionMap:
    EU1:
      Endpoint: ingress.coralogix.com:443
      Domain: coralogix.com
    EU2:
      Endpoint: ingress.eu2.coralogix.com:443
      Domain: eu2.coralogix.com
    AP1:
      Endpoint: ingress.coralogix.in:443
      Domain: coralogix.in
    AP2:
      Endpoint: ingress.coralogixsg.com:443
      Domain: coralogixsg.com
    AP3:
      Endpoint: ingress.ap3.coralogix.com:443
      Domain: ap3.coralogix.com
    US1:
      Endpoint: ingress.coralogix.us:443
      Domain: coralogix.us
    US2:
      Endpoint: ingress.cx498.coralogix.com:443
      Domain: cx498.coralogix.com

Resources:

  # IAM Role for Receiver (only created when not using external role)
  OtelReceiverTaskExecutionRole:
    Type: AWS::IAM::Role
    Condition: UseExternalRole
    Properties:
      RoleName: !Sub "${AWS::StackName}-otel-receiver-task-execution-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyName: S3ReadAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource: !Sub "arn:aws:s3:::${S3ConfigBucket}/*"
        - PolicyName: CloudMapDiscovery
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - servicediscovery:DiscoverInstances
                  - servicediscovery:ListInstances
                  - servicediscovery:ListServices
                  - servicediscovery:ListNamespaces
                Resource: "*"

  OtelReceiverCloudMapService:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Name: grpc-receiver
      NamespaceId: !Ref NamespaceId
      DnsConfig:
        DnsRecords:
          - Type: A
            TTL: 60
      HealthCheckCustomConfig:
        FailureThreshold: 1

  OtelReceiverTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ExecutionRoleArn: !If
        - UseExternalRole
        - !Ref OtelReceiverTaskExecutionRole
        - !Ref TaskExecutionRoleArn
      TaskRoleArn: !If
        - UseExternalRole
        - !Ref OtelReceiverTaskExecutionRole
        - !Ref TaskExecutionRoleArn
      Family: opentelemetry-receiver
      RequiresCompatibilities: [EC2]
      NetworkMode: awsvpc

      ContainerDefinitions:
        - Name: coralogix-otel-receiver
          Cpu: 0
          Memory: !Ref Memory
          Command: ["--config", !Sub "s3://${S3ConfigBucket}.s3.${AWS::Region}.amazonaws.com/${ReceiverS3ConfigKey}"]
          Image: !Sub "coralogixrepo/coralogix-otel-collector:${CDOTImageVersion}"
          Essential: true
          PortMappings:
            - ContainerPort: 4317
              Name: grpc
              Protocol: tcp
              AppProtocol: grpc
            - ContainerPort: 4318
              Name: http
              Protocol: tcp
            - ContainerPort: 8888
              Name: metrics
              Protocol: tcp
            - ContainerPort: 1777
              Name: pprof
              Protocol: tcp
          Privileged: true
          Environment:
            - Name: CORALOGIX_DOMAIN
              Value: !FindInMap [CoralogixRegionMap, !Ref CoralogixRegion, Domain]
            - Name: PRIVATE_KEY
              Value: !Ref CoralogixApiKey
            - Name: APP_NAME
              Value: !Ref ApplicationName
            - Name: SUB_SYS
              Value: !Ref SubsystemName
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: "/ecs/opentelemetry-receiver"
              mode: "non-blocking"
              awslogs-create-group: "true"
              max-buffer-size: "25m"
              awslogs-region: "us-east-1"
              awslogs-stream-prefix: "ecs"

  OtelReceiverService:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref ClusterName
      LaunchType: EC2
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups: [!Ref SecurityGroupId]
          Subnets: !Split [",", !Ref SubnetIds]
      ServiceName: coralogix-otel-receiver
      ServiceRegistries:
        - RegistryArn: !GetAtt OtelReceiverCloudMapService.Arn
      SchedulingStrategy: REPLICA
      DesiredCount: !Ref ReceiverTaskCount
      DeploymentController:
        Type: ECS
      EnableECSManagedTags: true
      TaskDefinition: !Ref OtelReceiverTaskDefinition

Outputs:
  ReceiverServiceDiscoveryName:
    Description: "Service discovery DNS name for receiver"
    Value: !Sub "grpc-receiver.cx-otel"
    Export:
      Name: !Sub "${AWS::StackName}-receiver-dns"
  ReceiverServiceArn:
    Description: "Receiver service ARN"
    Value: !Ref OtelReceiverService
    Export:
      Name: !Sub "${AWS::StackName}-receiver-service-arn" 